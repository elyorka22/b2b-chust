# Диагностика проблем бота и админ панели

## Проблема 1: Welcome message не отправляется

### Возможные причины:

1. **Переменная окружения `BACKEND_URL` не установлена или неправильная**
   - Бот использует `process.env.BACKEND_URL || 'http://localhost:3001'`
   - Если переменная не установлена, бот будет обращаться к `http://localhost:3001`
   - **Решение**: Убедитесь, что в окружении бота установлена переменная `BACKEND_URL` с правильным URL backend сервера
   - Пример: `BACKEND_URL=https://your-backend.railway.app`

2. **Welcome message не сохранен в базе данных**
   - API возвращает `{ key: 'welcome_message', value: null }` если настройка не найдена
   - **Решение**: 
     - Откройте админ панель
     - Перейдите в раздел "Telegram Bot boshqaruvi"
     - Нажмите "Welcome xabar sozlash"
     - Введите и сохраните welcome message

3. **Ошибка подключения к backend**
   - Бот не может достучаться до backend API
   - **Решение**: Проверьте логи бота - там будут видны ошибки подключения
   - Убедитесь, что backend доступен по URL, указанному в `BACKEND_URL`

4. **CORS или авторизация**
   - Backend может блокировать запросы от бота
   - **Решение**: Убедитесь, что endpoint `/api/bot/settings/:key` доступен без авторизации (сейчас он открыт)

### Как проверить:

1. Проверьте логи бота при отправке `/start`:
   ```
   [BOT] Получение welcome message из ...
   [BOT] Ответ от API: ...
   [BOT] Welcome message из API: ...
   ```

2. Проверьте логи backend при запросе от бота:
   ```
   [API] GET /api/bot/settings/welcome_message
   [API] Поиск настройки с ключом: welcome_message
   [API] Результат запроса: ...
   ```

## Проблема 2: Статистика не показывается в админ панели

### Возможные причины:

1. **Таблица `b2b_bot_users` не создана**
   - Миграция `010_create_bot_users_table.sql` не выполнена
   - **Решение**: Выполните миграцию в Supabase SQL Editor:
     ```sql
     -- Скопируйте содержимое файла supabase/migrations/010_create_bot_users_table.sql
     -- и выполните в Supabase SQL Editor
     ```

2. **Пользователи не сохраняются в базу**
   - Бот не может достучаться до `/api/bot/users`
   - Ошибки при сохранении игнорируются
   - **Решение**: 
     - Проверьте логи бота - там будут видны ошибки сохранения
     - Проверьте логи backend при запросе от бота
     - Убедитесь, что таблица `b2b_bot_users` существует

3. **Переменная окружения `BACKEND_URL` не установлена в боте**
   - Бот не может сохранить пользователя, так как не знает адрес backend
   - **Решение**: Установите `BACKEND_URL` в окружении бота

4. **Статистика использует fallback на `b2b_users`**
   - Если таблица `b2b_bot_users` не существует, статистика пытается использовать `b2b_users`
   - Но в `b2b_users` нет пользователей бота (только продавцы и админы)
   - **Решение**: Создайте таблицу `b2b_bot_users` через миграцию

### Как проверить:

1. Проверьте логи backend при запросе статистики:
   ```
   [STATS] Начало сбора статистики бота
   [STATS] Попытка получить данные из b2b_bot_users
   [STATS] Получено X пользователей из b2b_bot_users
   [STATS] Итоговая статистика: ...
   ```

2. Проверьте, существует ли таблица в Supabase:
   - Откройте Supabase Dashboard
   - Перейдите в Table Editor
   - Проверьте, есть ли таблица `b2b_bot_users`

3. Проверьте, сохраняются ли пользователи:
   - Отправьте `/start` боту
   - Проверьте логи backend - должен быть запрос `POST /api/bot/users`
   - Проверьте таблицу `b2b_bot_users` в Supabase - должен появиться новый пользователь

## Общие рекомендации:

1. **Проверьте переменные окружения бота:**
   - `TELEGRAM_BOT_TOKEN` - должен быть установлен
   - `BACKEND_URL` - должен указывать на правильный адрес backend
   - `FRONTEND_URL` - должен указывать на правильный адрес frontend

2. **Проверьте логи:**
   - Логи бота покажут все запросы к API
   - Логи backend покажут все входящие запросы
   - Ищите префиксы `[BOT]`, `[API]`, `[STATS]` для быстрого поиска

3. **Выполните миграции:**
   - Убедитесь, что все миграции из папки `supabase/migrations/` выполнены
   - Особенно важна миграция `010_create_bot_users_table.sql`

4. **Проверьте доступность API:**
   - Убедитесь, что backend доступен по URL из `BACKEND_URL`
   - Проверьте, что endpoint `/api/bot/settings/welcome_message` работает
   - Проверьте, что endpoint `/api/bot/users` работает




